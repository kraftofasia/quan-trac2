<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bảng Dữ liệu Quan trắc Nước thải</title>
    <style>
        /* CSS đã được tối ưu hóa cho bảng dữ liệu */
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; background-color: #eef1f6; }
        
        #data-container { overflow-x: auto; margin-top: 0; padding-top: 20px; }
        
        /* Cập nhật style để bảng chiếm toàn bộ không gian và không có padding trên */
        table { 
            width: 100%; /* Bảng chiếm 100% chiều rộng */
            margin: 0 auto; /* Bỏ căn giữa margin */
            border-collapse: collapse; 
            background-color: #fff; 
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); 
        }
        th, td { 
            padding: 12px 15px; 
            border: 1px solid #ddd; 
            text-align: center; 
            font-size: 14px; 
        }
        th { 
            background-color: #007bff; 
            color: white; 
            font-weight: bold;
            font-size: 16px;
        }
        tr:nth-child(even) { background-color: #f9f9f9; } 
        .loading { text-align: center; color: #555; padding: 50px; }
    </style>
</head>
<body>
    <div class="loading" id="loading-message">Đang tải dữ liệu...</div>
    <div id="data-container">
        </div>

    <script>
        // URL Apps Script của bạn (giữ nguyên)
        const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwgJWf_6CdmX3ouxNYEipdUM_tJYQWX3i_oZ_A90iYyyrLsgyCZfs-hdJUnEbXr0BJs/exec"; 
        
        const dataContainer = document.getElementById('data-container');
        const loadingMessage = document.getElementById('loading-message');

        // Danh sách các tham số muốn hiển thị trong bảng theo thứ tự
        const DISPLAY_PARAMS = ["TIME", "FlowIn", "Flow", "pH", "Temp", "COD", "TSS", "NH4"];
        
        /**
         * Lấy dữ liệu từ Google Apps Script Web App.
         */
        async function fetchData() {
            try {
                const response = await fetch(APPS_SCRIPT_URL);
                if (!response.ok) {
                    throw new Error(`Lỗi HTTP: ${response.status}`);
                }
                const data = await response.json();
                
                loadingMessage.style.display = 'none';

                if (data && data.length > 0) {
                    // Hiển thị tất cả dữ liệu
                    renderDataTable(data); 
                } else {
                    dataContainer.innerHTML = "<p style='text-align: center; color: orange;'>Không có dữ liệu quan trắc được trả về từ API.</p>";
                }

            } catch (error) {
                loadingMessage.style.display = 'none';
                dataContainer.innerHTML = `<p style="color: red; text-align: center;">Lỗi khi tải dữ liệu: ${error.message}</p>`;
                console.error("Lỗi: ", error);
            }
        }

        /**
         * Tạo và hiển thị bảng HTML từ TOÀN BỘ MẢNG dữ liệu.
         * @param {Array} data - Mảng các đối tượng dữ liệu quan trắc.
         */
        function renderDataTable(data) {
            dataContainer.innerHTML = ''; 
            
            let tableHTML = '<table>';

            // Tạo Header Row
            tableHTML += '<thead><tr>';
            DISPLAY_PARAMS.forEach(header => {
                tableHTML += `<th>${header}</th>`;
            });
            tableHTML += '</tr></thead>';

            // Tạo Body (Vòng lặp qua TẤT CẢ các mục dữ liệu)
            tableHTML += '<tbody>';

            data.forEach(item => {
                tableHTML += '<tr>';
                
                const measurementData = item.data || {}; 

                DISPLAY_PARAMS.forEach(key => {
                    let cellValue = 'N/A'; // Giá trị mặc định

                    if (key === "TIME") {
                        // Lấy thời gian trực tiếp từ đối tượng gốc
                        cellValue = item.time || item.TIME || 'N/A';
                    } else {
                        // Lấy dữ liệu từ đối tượng measurementData (tức là item.data)
                        const paramData = measurementData[key];
                        
                        if (typeof paramData === 'object' && paramData !== null && paramData.value !== undefined) {
                            const rawValue = paramData.value;
                            // Làm tròn 2 chữ số thập phân nếu là số
                            cellValue = (typeof rawValue === 'number') ? rawValue.toFixed(2) : rawValue; 
                        } else if (paramData !== undefined) {
                            // Trường hợp dữ liệu tồn tại nhưng không phải là đối tượng {value, status}
                            cellValue = paramData;
                            if (typeof cellValue === 'number') {
                                cellValue = cellValue.toFixed(2);
                            }
                        }
                    }
                    
                    tableHTML += `<td>${cellValue}</td>`;
                });
                
                tableHTML += '</tr>'; 
            });

            tableHTML += '</tbody>';
            tableHTML += '</table>';

            dataContainer.innerHTML = tableHTML;
        }

        // Tải dữ liệu lần đầu và thiết lập cập nhật
        fetchData();
        setInterval(fetchData, 60000); 
    </script>
</body>
</html>
